<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>   
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#D32F2F">  
    <meta name="mobile-web-app-capable" content="yes">  
    <meta name="apple-mobile-web-app-capable" content="yes">  
    <meta name="apple-mobile-app-status-bar-style" content="black-translucent">  
    <meta name="description" content="Ù…ØªØ¬Ø± ZOONA Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - Ø§Ù„ØªØ³ÙˆÙ‚ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙŠ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†">  
    <meta name="keywords" content="zoona, Ù…ØªØ¬Ø±, ØªØ³ÙˆÙ‚, Ø³ÙˆØ¯Ø§Ù†ÙŠ, Ø´Ø±Ø§Ø¡, Ù…Ù†ØªØ¬Ø§Øª, Ø³ÙˆØ¯Ø§Ù†">  
    <meta name="author" content="ZOONA">  
    <title>ZOONA</title>  
    <link rel="manifest" href="manifest.json">  
    <link rel="icon" type="image/png" href="icon/icon-72x72.png">  
    <link rel="apple-touch-icon" href="icon/icon-152x152.png">  
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">  
  
<style>  
    * {  
        margin: 0;  
        padding: 0;  
        box-sizing: border-box;  
        -webkit-tap-highlight-color: transparent;  
    }  
      
    body, html {  
        width: 100%;  
        height: 100%;  
        overflow: hidden;  
        font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, sans-serif;  
        background: #FFFFFF;  
        position: fixed;  
    }  
      
    #splash {  
        position: fixed;  
        top: 0;  
        left: 0;  
        width: 100%;  
        height: 100%;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        display: flex;  
        flex-direction: column;  
        justify-content: center;  
        align-items: center;  
        z-index: 9999;  
        transition: opacity 0.5s;  
    }  
      
    .splash-logo {  
        width: 150px;  
        height: 150px;  
        margin-bottom: 20px;  
        animation: pulse 2s infinite;  
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));  
    }  
      
    .splash-text {  
        color: white;  
        font-size: 20px;  
        font-weight: 700;  
        margin-top: 20px;  
        letter-spacing: 1px;  
        font-family: 'Tajawal', sans-serif;  
    }  
      
    .loader {  
        width: 60px;  
        height: 4px;  
        background: rgba(255,255,255,0.3);  
        margin-top: 30px;  
        border-radius: 2px;  
        overflow: hidden;  
    }  
      
    .loader::after {  
        content: '';  
        display: block;  
        width: 50%;  
        height: 100%;  
        background: white;  
        border-radius: 2px;  
        animation: loading 1.5s infinite ease-in-out;  
    }  
      
    @keyframes pulse {  
        0% { transform: scale(1); }  
        50% { transform: scale(1.05); }  
        100% { transform: scale(1); }  
    }  
      
    @keyframes loading {  
        0% { transform: translateX(-100%); }  
        100% { transform: translateX(200%); }  
    }  
      
    #webview-container {  
        width: 100%;  
        height: 100%;  
        display: none;  
    }  
      
    #webview {  
        width: 100%;  
        height: 100%;  
        border: none;  
        background: #FFFFFF;  
    }  
      
    .status-bar {  
        height: env(safe-area-inset-top, 0px);  
        background: #D32F2F;  
        width: 100%;  
    }  
      
    #back-button {  
        position: fixed;  
        bottom: 25px;  
        left: 25px;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        color: white;  
        width: 56px;  
        height: 56px;  
        border-radius: 28px;  
        display: none;  
        justify-content: center;  
        align-items: center;  
        box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);  
        z-index: 1000;  
        border: none;  
        cursor: pointer;  
        font-size: 22px;  
        font-weight: bold;  
        transition: all 0.3s ease;  
        font-family: 'Tajawal', sans-serif;  
    }  
      
    #back-button:hover {  
        transform: scale(1.1);  
        box-shadow: 0 8px 25px rgba(211, 47, 47, 0.5);  
    }  
      
    #back-button:active {  
        transform: scale(0.95);  
    }  
      
    #toast {  
        position: fixed;  
        bottom: 90px;  
        left: 50%;  
        transform: translateX(-50%);  
        background: #D32F2F;  
        color: white;  
        padding: 16px 32px;  
        border-radius: 28px;  
        display: none;  
        z-index: 1001;  
        box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);  
        font-weight: 600;  
        max-width: 85%;  
        text-align: center;  
        backdrop-filter: blur(10px);  
        border: 1px solid rgba(255,255,255,0.1);  
        font-family: 'Tajawal', sans-serif;  
        font-size: 15px;  
        animation: slideUp 0.3s ease-out;  
    }  
      
    @keyframes slideUp {  
        from {  
            opacity: 0;  
            transform: translateX(-50%) translateY(20px);  
        }  
        to {  
            opacity: 1;  
            transform: translateX(-50%) translateY(0);  
        }  
    }  
      
    .offline-message {  
        position: fixed;  
        top: 0;  
        left: 0;  
        width: 100%;  
        background: #B71C1C;  
        color: white;  
        text-align: center;  
        padding: 16px;  
        display: none;  
        z-index: 1002;  
        font-weight: 600;  
        box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);  
        font-family: 'Tajawal', sans-serif;  
        font-size: 15px;  
    }  
      
    #refresh-button {  
        position: fixed;  
        bottom: 25px;  
        right: 25px;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        color: white;  
        width: 56px;  
        height: 56px;  
        border-radius: 28px;  
        display: none;  
        justify-content: center;  
        align-items: center;  
        box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);  
        z-index: 1000;  
        border: none;  
        cursor: pointer;  
        font-size: 22px;  
        transition: all 0.3s ease;  
        font-family: 'Tajawal', sans-serif;  
    }  
      
    #refresh-button:hover {  
        transform: rotate(30deg);  
    }  
      
    /* ØªØ­Ø³ÙŠÙ† Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø­Ø¨ */  
    .pull-indicator {  
        position: fixed;  
        top: -80px;  
        left: 0;  
        width: 100%;  
        height: 80px;  
        background: linear-gradient(to bottom, #D32F2F, #B71C1C);  
        display: flex;  
        justify-content: center;  
        align-items: center;  
        color: white;  
        z-index: 999;  
        transition: top 0.3s ease;  
        font-family: 'Tajawal', sans-serif;  
        font-weight: 600;  
        font-size: 16px;  
        padding-top: env(safe-area-inset-top, 0px);  
    }  
      
    .pull-indicator.show {  
        top: 0;  
    }  
      
    .pull-indicator .icon {  
        margin-left: 10px;  
        font-size: 20px;  
        transition: transform 0.3s;  
    }  
      
    .background-pattern {  
        position: fixed;  
        top: 0;  
        left: 0;  
        width: 100%;  
        height: 100%;  
        background-image:   
            radial-gradient(circle at 25% 25%, rgba(211, 47, 47, 0.03) 0%, transparent 50%),  
            radial-gradient(circle at 75% 75%, rgba(183, 28, 28, 0.03) 0%, transparent 50%);  
        pointer-events: none;  
        z-index: -1;  
    }  
      
    .welcome-message {  
        position: fixed;  
        top: 20px;  
        right: 20px;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        color: white;  
        padding: 12px 24px;  
        border-radius: 25px;  
        z-index: 1003;  
        box-shadow: 0 6px 20px rgba(211, 47, 47, 0.3);  
        font-family: 'Tajawal', sans-serif;  
        font-weight: 700;  
        font-size: 15px;  
        display: none;  
        animation: fadeInDown 0.5s ease-out;  
        border: 2px solid rgba(255,255,255,0.2);  
    }  
      
    @keyframes fadeInDown {  
        from {  
            opacity: 0;  
            transform: translateY(-20px);  
        }  
        to {  
            opacity: 1;  
            transform: translateY(0);  
        }  
    }  

    /* Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
    @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>

</head>  
<body id="zoona-app" data-app-type="webview" data-store="sudan">  
    <div class="background-pattern"></div>
    <div class="status-bar"></div>
    <div class="welcome-message" id="welcome-message">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…ØªØ¬Ø± ZOONA Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠ</div>
    <div class="pull-indicator" id="pull-indicator">
        <span>Ø­Ø±Ø± Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</span>
        <span class="icon">âŸ³</span>
    </div>
    <div id="splash">  
        <img src="assets/splash-logo.png" alt="ZOONA Logo" class="splash-logo">  
        <div class="splash-text">ZOONA</div>  
        <div class="loader"></div>  
    </div>
    <div class="offline-message" id="offline-message">âš ï¸ Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©.</div>
    <div id="webview-container">  
        <iframe id="webview"   
                allow="geolocation; camera; microphone; autoplay; clipboard-write; encrypted-media"  
                allowfullscreen  
                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-downloads"  
                referrerpolicy="strict-origin-when-cross-origin"  
                title="Ù…ØªØ¬Ø± ZOONA Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠ"></iframe>  
    </div>
    <button id="back-button" aria-label="Ø±Ø¬ÙˆØ¹">â†</button>  
    <button id="refresh-button" aria-label="ØªØ­Ø¯ÙŠØ«">â†»</button>
    <div id="toast"></div>
  
<script>  
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ù…ØªØºÙŠØ± url  
    const params = new URLSearchParams(window.location.search);  
    let siteURL = params.get("url");  

    // Ø§Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· â†’ Ù†ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©  
    if (!siteURL) {  
        siteURL = "https://www.zoonasd.com/";  
    }  

    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©  
    const appName = "ZOONA";  
    const webview = document.getElementById("webview");  
    const splash = document.getElementById("splash");  
    const webviewContainer = document.getElementById('webview-container');  
    const backButton = document.getElementById('back-button');  
    const refreshButton = document.getElementById('refresh-button');  
    const toast = document.getElementById('toast');  
    const offlineMessage = document.getElementById('offline-message');  
    const welcomeMessage = document.getElementById('welcome-message');  
    const pullIndicator = document.getElementById('pull-indicator');  
    const appBaseURL = window.location.origin + window.location.pathname;
      
    // ØªØ¹ÙŠÙŠÙ† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚  
    document.title = appName;  
      
    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ«  
    let startY = 0;  
    let currentY = 0;  
    let isPulling = false;  
    let pullStartTime = 0;  
    let isRefreshing = false;
    
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØµÙØ­
    function updateBrowserURL(currentPageURL) {
        try {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const newURL = `${appBaseURL}?url=${encodeURIComponent(currentPageURL)}`;
            
            // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            if (window.history && window.history.replaceState) {
                window.history.replaceState(null, '', newURL);
                console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø·:', newURL);
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø·:', error);
        }
    }
      
    // ØªÙ‡ÙŠØ¦Ø© Service Worker  
    if ('serviceWorker' in navigator) {  
        window.addEventListener('load', () => {  
            navigator.serviceWorker.register('service-worker.js')  
                .then(registration => {  
                    console.log('ServiceWorker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù„ØªØ·Ø¨ÙŠÙ‚ ZOONA');  
                })  
                .catch(err => {  
                    console.error('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ ServiceWorker:', err);  
                });  
        });  
    }  
      
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª  
    function showToast(message, duration = 3000) {  
        toast.textContent = message;  
        toast.style.display = 'block';  
          
        setTimeout(() => {  
            toast.style.display = 'none';  
        }, duration);  
    }  
      
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨  
    function showWelcomeMessage() {  
        const today = new Date().toDateString();  
        const lastWelcomeDate = localStorage.getItem('zoona_last_welcome_date');  
          
        if (lastWelcomeDate !== today) {  
            welcomeMessage.style.display = 'block';  
            localStorage.setItem('zoona_last_welcome_date', today);  
              
            setTimeout(() => {  
                welcomeMessage.style.display = 'none';  
            }, 5000);  
              
            showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø£ÙƒØ¨Ø± Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠØ© ', 3000);  
        }  
    }  
      
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„  
    function showOfflineMessage() {  
        offlineMessage.style.display = 'block';  
        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„', 3000);  
          
        setTimeout(() => {  
            offlineMessage.style.display = 'none';  
        }, 5000);  
    }  
      
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª  
    function updateOnlineStatus() {  
        if (navigator.onLine) {  
            offlineMessage.style.display = 'none';  
              
            if (!isPulling) {  
                pullIndicator.classList.remove('show');  
            }  
        } else {  
            showOfflineMessage();  
        }  
    }  
      
    // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„  
    window.addEventListener('online', updateOnlineStatus);  
    window.addEventListener('offline', updateOnlineStatus);  
      
    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ Ù„Ø£Ø³ÙÙ„ Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø³Ù†
    let lastScrollTop = 0;
    
    document.addEventListener('touchstart', (e) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
        const webviewScrollTop = webview.contentWindow?.pageYOffset || 0;
        
        if (webviewScrollTop <= 5 && !isPulling && !isRefreshing) {
            startY = e.touches[0].clientY;
            currentY = startY;
            isPulling = true;
            pullStartTime = Date.now();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±
            pullIndicator.style.top = '-80px';
            pullIndicator.querySelector('.icon').style.transform = 'rotate(0deg)';
        }
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        
        currentY = e.touches[0].clientY;
        const pullDistance = currentY - startY;
        
        if (pullDistance > 0) {
            e.preventDefault();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰
            const maxPull = 150;
            const calculatedTop = Math.min(pullDistance, maxPull) - 80;
            pullIndicator.style.top = calculatedTop + 'px';
            
            // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ©
            const iconRotation = Math.min((pullDistance / maxPull) * 360, 360);
            pullIndicator.querySelector('.icon').style.transform = `rotate(${iconRotation}deg)`;
            
            // ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ©
            if (pullDistance > 100) {
                pullIndicator.querySelector('span:first-child').textContent = 'Ø­Ø±Ø± Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©';
                pullIndicator.classList.add('show');
            } else {
                pullIndicator.querySelector('span:first-child').textContent = 'Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ«';
                pullIndicator.classList.remove('show');
            }
        }
    });
    
    document.addEventListener('touchend', () => {
        if (!isPulling) return;
        
        const pullDistance = currentY - startY;
        const pullDuration = Date.now() - pullStartTime;
        
        isPulling = false;
        
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¨Ø³Ù„Ø§Ø³Ø©
        pullIndicator.style.transition = 'top 0.3s ease';
        pullIndicator.style.top = '-80px';
        
        setTimeout(() => {
            pullIndicator.style.transition = '';
        }, 300);
        
        // Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø­Ø¨ 100 Ø¨ÙƒØ³Ù„ ÙˆÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¯Ø© Ø£Ù‚Ù„ Ù…Ù† Ø«Ø§Ù†ÙŠØ©
        if (pullDistance > 100 && pullDuration < 1000) {
            isRefreshing = true;
            pullIndicator.classList.remove('show');
            
            showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©...', 1500);
            
            // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (webview.contentWindow) {
                setTimeout(() => {
                    webview.contentWindow.location.reload();
                    isRefreshing = false;
                }, 300);
            }
        } else if (pullDistance > 50) {
            // Ø³Ø­Ø¨ ØºÙŠØ± ÙƒØ§ÙÙŠØŒ Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ø³Ù„Ø§Ø³Ø©
            pullIndicator.querySelector('.icon').style.transform = 'rotate(0deg)';
        }
    });
      
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚  
    document.addEventListener('DOMContentLoaded', () => {  
        updateOnlineStatus();  
          
        // Ù…Ø­Ø§ÙƒØ§Ø© ÙˆÙ‚Øª ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø©  
        setTimeout(() => {  
            loadWebview();  
        }, 2000);  
          
        // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©  
        backButton.addEventListener('click', () => {  
            if (webview.contentWindow && webview.contentWindow.history.length > 1) {  
                webview.contentWindow.history.back();  
                showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 1500);  
            }  
        });  
          
        // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«  
        refreshButton.addEventListener('click', () => {  
            if (webview.contentWindow) {  
                showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©...', 1500);  
                webview.contentWindow.location.reload();  
            }  
        });  
          
        // ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…  
        setInterval(() => {  
            try {  
                // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©  
                if (webview.contentWindow && webview.contentWindow.history.length > 1) {  
                    backButton.style.display = 'flex';  
                } else {  
                    backButton.style.display = 'none';  
                }  
                  
                // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«  
                if (webview.contentWindow) {  
                    refreshButton.style.display = 'flex';  
                }  
            } catch (e) {  
                backButton.style.display = 'none';  
                refreshButton.style.display = 'none';  
            }  
        }, 1000);  
    });  
      
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹  
    function loadWebview() {  
        webview.src = siteURL;  
          
        webview.onload = () => {  
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„  
            splash.style.opacity = '0';  
            setTimeout(() => {  
                splash.style.display = 'none';  
                webviewContainer.style.display = 'block';  
            }, 500);  
              
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©  
            try {  
                const pageTitle = webview.contentWindow.document.title;  
                const currentURL = webview.contentWindow.location.href;
                
                // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                updateBrowserURL(currentURL);
                
                if (pageTitle && pageTitle !== "" && pageTitle !== "ZOONA") {  
                    document.title = `${pageTitle} | ${appName}`;  
                }  
            } catch (e) {  
                console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©:', e);  
            }  
              
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·  
            setTimeout(() => {  
                showWelcomeMessage();  
            }, 1000);  
              
            // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ webview
            setupWebviewNavigationTracking();
              
            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙÙŠØ¯ Ø¨Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²  
            try {  
                webview.contentWindow.postMessage({  
                    type: 'app_ready',  
                    app_name: 'ZOONA Store',  
                    country: 'Sudan',  
                    features: {  
                        storage: true,  
                        geolocation: true,  
                        download: true,  
                        version: '1.0.0',  
                        currency: 'SDG'  
                    }  
                }, '*');  
            } catch (e) {  
                console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø·Ø§Ø±');  
            }  
        };  
          
        webview.onerror = () => {  
            splash.innerHTML = `  
                <div style="text-align: center; color: white; padding: 20px; font-family: 'Tajawal', sans-serif;">  
                    <h2 style="margin-bottom: 20px; font-weight: 700;">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h2>  
                    <p style="margin-bottom: 30px; font-size: 16px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>  
                    <button onclick="location.reload()" style="  
                        margin-top: 20px;  
                        padding: 12px 40px;  
                        background: white;  
                        color: #D32F2F;  
                        border: none;  
                        border-radius: 25px;  
                        font-size: 16px;  
                        cursor: pointer;  
                        font-weight: bold;  
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);  
                        font-family: 'Tajawal', sans-serif;  
                        transition: all 0.3s;  
                    " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';"  
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">  
                        Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©  
                    </button>  
                </div>  
            `;  
            showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 4000);  
        };  
    }
    
    // ØªØªØ¨Ø¹ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ webview
    function setupWebviewNavigationTracking() {
        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯Ø§Ø®Ù„ iframe
        let lastURL = webview.src;
        
        setInterval(() => {
            try {
                const currentURL = webview.contentWindow.location.href;
                
                if (currentURL !== lastURL) {
                    lastURL = currentURL;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØµÙØ­
                    updateBrowserURL(currentURL);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
                    const pageTitle = webview.contentWindow.document.title;
                    if (pageTitle && pageTitle !== "" && pageTitle !== "ZOONA") {
                        document.title = `${pageTitle} | ${appName}`;
                    }
                    
                    console.log('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø¥Ù„Ù‰:', currentURL);
                }
            } catch (e) {
                // ØµÙ…Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø­Ù‚ Ø§Ù„ÙˆØµÙˆÙ„
            }
        }, 500);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø¨Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
        try {
            const pushState = webview.contentWindow.history.pushState;
            const replaceState = webview.contentWindow.history.replaceState;
            
            webview.contentWindow.history.pushState = function() {
                pushState.apply(this, arguments);
                setTimeout(() => {
                    updateBrowserURL(webview.contentWindow.location.href);
                }, 100);
            };
            
            webview.contentWindow.history.replaceState = function() {
                replaceState.apply(this, arguments);
                setTimeout(() => {
                    updateBrowserURL(webview.contentWindow.location.href);
                }, 100);
            };
        } catch (e) {
            console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®:', e);
        }
    }
      
    // ------------ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ ------------  
    window.addEventListener("message", function(event) {  
        // Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ  
        if (event.data === "request_location") {  
            navigator.geolocation.getCurrentPosition(  
                (pos) => {  
                    webview.contentWindow.postMessage({  
                        status: "success",  
                        latitude: pos.coords.latitude,  
                        longitude: pos.coords.longitude,  
                        accuracy: pos.coords.accuracy,  
                        timestamp: pos.timestamp  
                    }, "*");  
                },  
                (err) => {  
                    webview.contentWindow.postMessage({  
                        status: "error",  
                        message: err.message,  
                        code: err.code  
                    }, "*");  
                },  
                {  
                    enableHighAccuracy: true,  
                    timeout: 15000,  
                    maximumAge: 0  
                }  
            );  
        }  
          
        // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª  
        else if (event.data.type === "download_file") {  
            const { url, filename, type } = event.data;  
            downloadFile(url, filename, type);  
        }  
          
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª  
        else if (event.data.type === "save_data") {  
            const { key, value } = event.data;  
            localStorage.setItem(`zoona_${key}`, JSON.stringify(value));  
            webview.contentWindow.postMessage({  
                type: "data_saved",  
                key: key,  
                success: true  
            }, "*");  
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ“', 2000);  
        }  
          
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª  
        else if (event.data.type === "get_data") {  
            const { key } = event.data;  
            const value = localStorage.getItem(`zoona_${key}`);  
            webview.contentWindow.postMessage({  
                type: "data_retrieved",  
                key: key,  
                value: value ? JSON.parse(value) : null,  
                success: true  
            }, "*");  
        }  
          
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª  
        else if (event.data.type === "clear_data") {  
            const { key } = event.data;  
            if (key === 'all') {  
                localStorage.clear();  
                showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 2000);  
            } else {  
                localStorage.removeItem(`zoona_${key}`);  
                showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 2000);  
            }  
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        else if (event.data.type === "update_url") {
            const { url } = event.data;
            if (url) {
                updateBrowserURL(url);
            }
        }  
    });  
      
    // Ø¯Ø§Ù„Ø© ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª  
    function downloadFile(url, filename, type = 'image') {  
        showToast(`Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ ${filename}... â³`, 3000);  
          
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');  
        const finalFilename = `${filename.replace(/\.[^/.]+$/, "")}_${timestamp}${filename.match(/\.[^/.]+$/)?.[0] || ''}`;  
          
        fetch(url, {  
            mode: 'cors',  
            credentials: 'include'  
        })  
        .then(response => {  
            if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');  
            return response.blob();  
        })  
        .then(blob => {  
            const url = window.URL.createObjectURL(blob);  
            const a = document.createElement('a');  
            a.style.display = 'none';  
            a.href = url;  
            a.download = finalFilename;  
            a.setAttribute('download', finalFilename);  
              
            document.body.appendChild(a);  
            a.click();  
            window.URL.revokeObjectURL(url);  
            a.remove();  
              
            showToast(`ØªÙ… ØªÙ†Ø²ÙŠÙ„ ${filename} Ø¨Ù†Ø¬Ø§Ø­ âœ…`, 3000);  
              
            webview.contentWindow.postMessage({  
                type: "download_complete",  
                filename: finalFilename,  
                originalName: filename,  
                success: true,  
                timestamp: new Date().toISOString()  
            }, "*");  
              
            const downloads = JSON.parse(localStorage.getItem('zoona_downloads') || '[]');  
            downloads.unshift({  
                filename: finalFilename,  
                originalName: filename,  
                type: type,  
                date: new Date().toISOString(),  
                url: url  
            });  
            localStorage.setItem('zoona_downloads', JSON.stringify(downloads.slice(0, 50)));  
        })  
        .catch(err => {  
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„:', err);  
            showToast('ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 3000);  
              
            webview.contentWindow.postMessage({  
                type: "download_complete",  
                filename: filename,  
                success: false,  
                error: err.message  
            }, "*");  
        });  
    }  
      
    // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©  
    document.addEventListener('contextmenu', e => {  
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {  
            e.preventDefault();  
        }  
    });  
      
    // Ø¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª ÙƒÙ€ PWA  
    let deferredPrompt;  
      
    window.addEventListener('beforeinstallprompt', (e) => {  
        e.preventDefault();  
        deferredPrompt = e;  
    });  
      
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©  
    window.addEventListener('load', () => {  
        const now = new Date().getTime();  
        const cacheData = JSON.parse(localStorage.getItem('zoona_cache_meta') || '{}');  
          
        for (const key in cacheData) {  
            if (now - cacheData[key].timestamp > 7 * 24 * 60 * 60 * 1000) {  
                localStorage.removeItem(key);  
                delete cacheData[key];  
            }  
        }  
          
        localStorage.setItem('zoona_cache_meta', JSON.stringify(cacheData));  
    });  
      
    // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡  
    let isScrolling;  
    window.addEventListener('scroll', () => {  
        window.clearTimeout(isScrolling);  
          
        isScrolling = setTimeout(() => {  
            backButton.style.opacity = '0.7';  
            refreshButton.style.opacity = '0.7';  
              
            setTimeout(() => {  
                backButton.style.opacity = '1';  
                refreshButton.style.opacity = '1';  
            }, 100);  
        }, 66);  
    }, false);  
      
    // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù…  
    if (!localStorage.getItem('zoona_first_use')) {  
        localStorage.setItem('zoona_first_use', new Date().toISOString());  
    }  
</script>

<!-- ØµÙ†Ø¯ÙˆÙ‚ ØªØ«Ø¨ÙŠØª PWA Ù…ÙØ­Ø³Ù‘Ù† -->
<div style="  
position: fixed;  
right: 16px;  
left: 16px;  
bottom: 20px;  
max-width: 420px;  
margin: 0 auto;  
border-radius: 20px;  
padding: 24px;  
background: #ffffff;  
color: #333333;  
box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.05);  
display: none;  
z-index: 100000;  
font-family: 'Tajawal', 'Segoe UI', Tahoma, sans-serif;  
direction: rtl;"  
id="pwa-install-box" aria-hidden="true" role="dialog">  
    <div id="pwa-close" title="Ø¥ØºÙ„Ø§Ù‚" style="  
        position:absolute;top:12px;left:12px;color:#999;font-size:20px;  
        cursor:pointer;width:32px;height:32px;display:flex;  
        align-items:center;justify-content:center;border-radius:50%;  
        transition: color 0.3s, background-color 0.3s;">  
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>  
    </div>  
    
    <div style="display:flex;gap:16px;align-items:center;">  
        <div style="  
            width: 72px;  
            height: 72px;  
            border-radius: 18px;  
            background: #f7f7f7;  
            display:flex;align-items:center;justify-content:center;  
            flex-shrink:0;box-shadow: 0 4px 12px rgba(0,0,0,0.1);  
            overflow:hidden;">  
            <img src="https://i.ibb.co/pvjQjT2V/icon-512x512.png"   
                 style="width: 52px; height: 52px; border-radius: 10px; object-fit: cover;">  
        </div>  
    
        <div style="flex:1;text-align:right;">  
            <div style="font-weight: 800; font-size: 18px; margin-bottom: 4px; color: #c62828;">  
                ØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚ <span style="font-family:'Segoe UI', Tahoma, sans-serif;">ZOONA</span>  
            </div>  
            <div style="font-size: 14px; color: #555555; line-height: 1.5;">  
                âœ¨ ØªØ¬Ø±Ø¨Ø© Ø´Ø±Ø§Ø¡ Ø£Ø³Ø±Ø¹ â€” ØªØ«Ø¨ÙŠØª Ù…Ø¨Ø§Ø´Ø± Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©  
            </div>  
        </div>  
    </div>  
    
    <button id="pwa-install-btn" style="  
        width: 100%;  
        margin-top: 20px;   
        background: #c62828;  
        color: #fff;  
        border: none;  
        padding: 14px 20px;  
        border-radius: 14px;  
        font-weight: 700;  
        cursor: pointer;  
        box-shadow: 0 8px 20px rgba(198, 40, 40, 0.3),  
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);  
        text-align: center;  
        font-size: 16px;  
        letter-spacing: 0.5px;  
        transition: background-color 0.3s ease;">  
        ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù† ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ§Ø¦Ù‚  
    </button>  
</div>  

<script>  
document.addEventListener('DOMContentLoaded', function() {  
    let deferredPrompt = null;  
    const box = document.getElementById('pwa-install-box');  
    const btn = document.getElementById('pwa-install-btn');  
    const close = document.getElementById('pwa-close');  
  
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ«Ø¨ÙŠØª PWA Ø¨Ø¯Ù‚Ø© Ø£ÙƒØ¨Ø±
    function isPWAInstalled() {
        // Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
        const isMinimalUI = window.matchMedia('(display-mode: minimal-ui)').matches;
        
        // Ù„Ù„Ù€ iOS
        const isIOSStandalone = ('standalone' in window.navigator) && 
                               (window.navigator.standalone === true);
        
        // Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚Ø§Øª pwabuilder.com Ø£Ùˆ Ø£ÙŠ PWA Ø¢Ø®Ø±
        const hasPWALauncher = document.referrer.includes('android-app://') || 
                              window.location.protocol === 'file:';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ service worker Ù†Ø´Ø·
        let hasActiveServiceWorker = false;
        if ('serviceWorker' in navigator) {
            const registrations = navigator.serviceWorker.getRegistrations();
            hasActiveServiceWorker = registrations.length > 0;
        }
        
        return isStandalone || isFullscreen || isMinimalUI || isIOSStandalone || 
               hasPWALauncher || hasActiveServiceWorker;
    }  
  
    function hasShownBefore() {  
        return localStorage.getItem('pwaInstallShown') === 'true';  
    }  
    
    function markAsShown() {  
        localStorage.setItem('pwaInstallShown', 'true');  
    }  
  
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
    function isMobileBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØµÙØ­Ø§Øª iOS
    function isIOSBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        return /iphone|ipad|ipod/.test(userAgent);
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØµÙØ­Ø§Øª Android
    function isAndroidBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        return /android/.test(userAgent);
    }
  
    window.addEventListener('beforeinstallprompt', (e) => {  
        e.preventDefault();  
        deferredPrompt = e;  
  
        if (isPWAInstalled()) {
            console.log('PWA Ù…Ø«Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„');
            return;
        }  
        
        if (hasShownBefore()) {
            console.log('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„');
            return;
        }  
  
        // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
        const delay = isMobileBrowser() ? 3000 : 5000;
        
        setTimeout(() => {  
            box.style.display = 'block';
            console.log('Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª');
        }, delay);  
    });  
  
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… beforeinstallprompt
    if (!('beforeinstallprompt' in window)) {
        setTimeout(() => {
            if (!isPWAInstalled() && !hasShownBefore()) {
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                console.log('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
                
                // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ÙŠØ¯ÙˆÙŠ Ù„Ù„ØªØ«Ø¨ÙŠØª
                // Ø£Ùˆ Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            }
        }, 5000);
    }
  
    btn.addEventListener('click', async () => {  
        if (!deferredPrompt) {  
            box.style.display = 'none';  
            markAsShown();  
            
            // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØµÙØ­
            if (isIOSBrowser()) {
                alert('Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ iOS:\n1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©\n2. Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"');
            } else if (isAndroidBrowser()) {
                alert('Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Android:\n1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø«)\n2. Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"');
            } else {
                alert('Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:\n1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø«)\n2. Ø§Ø®ØªØ± "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" Ø£Ùˆ "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"');
            }
            
            return;  
        }  
  
        try {
            deferredPrompt.prompt();  
            const choiceResult = await deferredPrompt.userChoice;
            
            if (choiceResult.outcome === 'accepted') {
                console.log('Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªØ«Ø¨ÙŠØª PWA');
            } else {
                console.log('Ø±ÙØ¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ«Ø¨ÙŠØª PWA');
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ«Ø¨ÙŠØª PWA:', error);
        }
        
        box.style.display = 'none';  
        markAsShown();  
        deferredPrompt = null;  
    });  
  
    close.addEventListener('click', () => {  
        box.style.display = 'none';  
        markAsShown();  
    });  
  
    close.addEventListener('mouseenter', () => {  
        close.style.backgroundColor = '#f0f0f0';  
        close.style.color = '#333';  
    });  
  
    close.addEventListener('mouseleave', () => {  
        close.style.backgroundColor = 'transparent';  
        close.style.color = '#999';  
    });  
  
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± hover Ù„Ù„Ø²Ø±
    btn.addEventListener('mouseenter', () => {  
        btn.style.backgroundColor = '#b71c1c';  
    });  
    
    btn.addEventListener('mouseleave', () => {  
        btn.style.backgroundColor = '#c62828';  
    });  
  
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    if (isPWAInstalled()) {  
        box.style.display = 'none';  
    }  
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ÙŠÙ‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    document.addEventListener('click', (e) => {
        if (box.style.display === 'block' && 
            !box.contains(e.target) && 
            e.target !== btn) {
            box.style.display = 'none';
            markAsShown();
        }
    });
});  
</script>

<!-- Ø²Ø± ÙŠØ¯ÙˆÙŠ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) -->
<button id="manual-notification-btn" style="
  position: fixed;
  bottom: 100px;
  right: 25px;
  background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
  color: white;
  width: 56px;
  height: 56px;
  border-radius: 28px;
  display: none;
  justify-content: center;
  align-items: center;
  box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);
  z-index: 1000;
  border: none;
  cursor: pointer;
  font-size: 22px;
  transition: all 0.3s ease;
  font-family: 'Tajawal', sans-serif;
  z-index: 1004;
"
onclick="showNotificationSettings()">
  ğŸ””
</button>

<!-- Ù†Ø§ÙØ°Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© -->
<div id="custom-notification-prompt" style="display: none;">
  <div style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10010;
    background: #ffffff;
    border: 2px solid #D32F2F;
    border-radius: 20px;
    padding: 24px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    font-family: 'Tajawal', sans-serif;
    box-shadow: 0 20px 40px rgba(211, 47, 47, 0.25);
    direction: rtl;
    animation: fadeIn 0.3s ease-out;
  ">
    <div style="margin-bottom: 20px;">
      <div style="
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 36px;
        color: white;
        box-shadow: 0 8px 20px rgba(211, 47, 47, 0.3);
      ">
        ğŸ””
      </div>
      
      <h3 style="
        margin: 0 0 10px;
        color: #D32F2F;
        font-size: 22px;
        font-weight: 800;
      ">
        Ø¹Ø±ÙˆØ¶ Ø²ÙˆÙ†Ø§ Ø§Ù„Ø­ØµØ±ÙŠØ© ğŸ
      </h3>
      
      <p style="
        margin: 0 0 20px;
        font-size: 16px;
        color: #555;
        line-height: 1.5;
      ">
        ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙŠØ¹Ù†ÙŠ:<br>
        âœ“ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¹Ø±ÙˆØ¶<br>
        âœ“ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ø­ØµØ±ÙŠØ©<br>
        âœ“ Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§ØªÙƒ Ù„Ø­Ø¸Ø© Ø¨Ù„Ø­Ø¸Ø©<br>
        âœ“ Ø¹Ø±ÙˆØ¶ Ø®Ø§ØµØ© Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
      </p>
    </div>
    
    <div style="display: flex; gap: 12px; direction: rtl;">
      <button id="activate-notifications" style="
        flex: 1;
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
        color: #fff;
        border: none;
        padding: 16px 20px;
        border-radius: 14px;
        font-weight: 800;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 8px 20px rgba(211, 47, 47, 0.3);
        transition: all 0.3s ease;
        font-family: 'Tajawal', sans-serif;
      "
      onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 12px 25px rgba(211, 47, 47, 0.4)';"
      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 20px rgba(211, 47, 47, 0.3)';">
        ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      </button>
      
      <button id="decline-notifications" style="
        flex: 1;
        background: #fff;
        color: #D32F2F;
        border: 2px solid #D32F2F;
        padding: 16px 20px;
        border-radius: 14px;
        font-weight: 800;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        font-family: 'Tajawal', sans-serif;
      "
      onmouseover="this.style.background='#f9f9f9'; this.style.transform='scale(1.02)';"
      onmouseout="this.style.background='#fff'; this.style.transform='scale(1)';">
        Ù„Ø§Ø­Ù‚Ø§Ù‹
      </button>
    </div>
    
    <p style="
      margin: 15px 0 0;
      font-size: 13px;
      color: #888;
      font-weight: 500;
    ">
      ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    </p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxQLDLqr4W3lApfYLPjSV5It7925a9Rr0",
  authDomain: "double-carport-476915-j7.firebaseapp.com",
  projectId: "double-carport-476915-j7",
  storageBucket: "double-carport-476915-j7.firebasestorage.app",
  messagingSenderId: "122641462099",
  appId: "1:122641462099:web:345b777a88757d3ef7e7a6"
};

const VAPID_KEY = "BE2_9m83w2cu_fxhqV4eUowZQT7E8nm-FZZMWqN5DByd-Naykp52nWwA9uuW_L9x_3rPPsMNZzctsZD8j5YyaZw";

// ØªÙ‡ÙŠØ¦Ø© Firebase
const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// Ø¯Ø§Ù„Ø© Ù„Ø·Ù„Ø¨ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙˆÙƒÙ†
function requestAndSaveToken(registration) {
  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      getToken(messaging, {
        vapidKey: VAPID_KEY,
        serviceWorkerRegistration: registration
      }).then(token => {
        if (token) {
          console.log('FCM Token:', token);
          
          // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…
          fetch('/api/saveToken', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              token: token,
              device: navigator.userAgent,
              timestamp: new Date().toISOString(),
              app: 'ZOONA'
            })
          })
          .then(response => response.json())
          .then(data => {
            console.log('Token saved successfully:', data);
            showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
          })
          .catch(error => {
            console.error('Error saving token:', error);
            // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­Ù„ÙŠØ§Ù‹ Ø±ÙŠØ«Ù…Ø§ ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
            localStorage.setItem('fcm_token_pending', token);
          });
          
          // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­Ù„ÙŠØ§Ù‹
          localStorage.setItem('fcm_token', token);
          localStorage.setItem('notifications_enabled', 'true');
          localStorage.setItem('notifications_enabled_date', new Date().toISOString());
          
          // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¬Ø±Ø³ Ù„Ø£Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© Ø§Ù„Ø¢Ù† âœ…
          const bellBtn = document.getElementById('manual-notification-btn');
          if (bellBtn) bellBtn.style.display = 'none';
          
          // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
          const box = document.getElementById('custom-notification-prompt');
          if (box) box.style.display = 'none';
        }
      }).catch(error => {
        console.error('Error getting FCM token:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 3000);
      });
    } else if (permission === "denied") {
      localStorage.setItem('notifications_declined', 'true');
      localStorage.setItem('notifications_declined_date', new Date().toISOString());
      showToast('ØªÙ… Ø±ÙØ¶ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 2000);
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
      const box = document.getElementById('custom-notification-prompt');
      if (box) box.style.display = 'none';
    }
  });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø®ØµØµ
function showCustomNotification(notification) {
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø¥Ø´Ø¹Ø§Ø± Ù…Ø®ØµØµ
  const notificationElement = document.createElement('div');
  notificationElement.className = 'custom-notification';
  notificationElement.innerHTML = `
    <div style="
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);
      z-index: 10010;
      max-width: 350px;
      animation: slideInRight 0.3s ease-out;
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      border-right: 4px solid #FFEB3B;
    ">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="font-size: 24px;">ğŸ””</div>
        <div style="flex: 1;">
          <div style="font-weight: 800; font-size: 16px; margin-bottom: 4px;">
            ${notification.title || 'ZOONA'}
          </div>
          <div style="font-size: 14px; opacity: 0.9;">
            ${notification.body || 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯'}
          </div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">
          âœ•
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(notificationElement);
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
  setTimeout(() => {
    if (notificationElement.parentNode) {
      notificationElement.remove();
    }
  }, 5000);
}

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
onMessage(messaging, (payload) => {
  console.log('Message received:', payload);
  
  // Ø¥Ø´Ø¹Ø§Ø± Ù…Ø®ØµØµ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
  if (payload.notification) {
    showCustomNotification(payload.notification);
  }
});

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
window.showNotificationSettings = function() {
  const enabled = localStorage.getItem('notifications_enabled');
  const declined = localStorage.getItem('notifications_declined');
  
  let message = 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:\n\n';
  
  if (enabled) {
    message += 'âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©\n';
    const date = localStorage.getItem('notifications_enabled_date');
    if (date) {
      message += `ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙŠ: ${new Date(date).toLocaleDateString('ar-SA')}`;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¬Ø±Ø³ Ù„Ø£Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© âœ…
    const bellBtn = document.getElementById('manual-notification-btn');
    if (bellBtn) bellBtn.style.display = 'none';
    
    alert(message);
    return;
  } else if (declined) {
    message += 'âŒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¹Ø·Ù„Ø©\n';
    const date = localStorage.getItem('notifications_declined_date');
    if (date) {
      message += `ØªÙ… Ø§Ù„ØªØ¹Ø·ÙŠÙ„ ÙÙŠ: ${new Date(date).toLocaleDateString('ar-SA')}`;
    }
    message += '\nÙ‡Ù„ ØªØ±ØºØ¨ ÙÙŠ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ø§Ù„Ø¢Ù†ØŸ';
    
    if (confirm(message)) {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          requestAndSaveToken(registration);
        });
      }
      return;
    }
  } else {
    message += 'âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª\n';
    message += 'Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ø§Ù„Ø¢Ù†ØŸ';
    
    if (confirm(message)) {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          requestAndSaveToken(registration);
        });
      }
      return;
    }
  }
  
  if (!declined && !enabled) {
    if (confirm(message)) {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
          requestAndSaveToken(registration);
        });
      }
    }
  } else if (enabled || declined) {
    alert(message);
  }
};

// ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
window.addEventListener('load', function() {
  // Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
  setTimeout(() => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¬Ø±Ø³ âœ…
    const notificationsEnabled = localStorage.getItem('notifications_enabled');
    if (notificationsEnabled === 'true') {
      const bellBtn = document.getElementById('manual-notification-btn');
      if (bellBtn) bellBtn.style.display = 'none';
    }
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registered for notifications');
          
          // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
          const activateBtn = document.getElementById('activate-notifications');
          const declineBtn = document.getElementById('decline-notifications');
          
          if (activateBtn) {
            activateBtn.onclick = () => {
              requestAndSaveToken(registration);
            };
          }
          
          if (declineBtn) {
            declineBtn.onclick = () => {
              const box = document.getElementById('custom-notification-prompt');
              if (box) box.style.display = 'none';
              localStorage.setItem('notifications_declined', 'true');
              localStorage.setItem('notifications_declined_date', new Date().toISOString());
              
              // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¬Ø±Ø³ Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆÙ‚Ø¯ ÙŠØ±ØºØ¨ Ø¨ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ âœ…
              const bellBtn = document.getElementById('manual-notification-btn');
              if (bellBtn) {
                bellBtn.style.display = 'flex';
                // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø²Ø±
                setTimeout(() => {
                  bellBtn.style.display = 'flex';
                }, 100);
              }
              
              showToast('ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 3000);
            };
          }
          
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…Ø®Ø²Ù†
          const savedToken = localStorage.getItem('fcm_token');
          if (savedToken) {
            console.log('Found saved FCM token');
          }
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙˆÙƒÙ† Ù…Ø¹Ù„Ù‚
          const pendingToken = localStorage.getItem('fcm_token_pending');
          if (pendingToken && navigator.onLine) {
            fetch('/api/saveToken', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token: pendingToken })
            }).then(() => {
              localStorage.removeItem('fcm_token_pending');
            });
          }
          
          // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          setTimeout(() => {
            const box = document.getElementById('custom-notification-prompt');
            const userDeclined = localStorage.getItem('notifications_declined');
            const userEnabled = localStorage.getItem('notifications_enabled');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙˆØ· Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶
            if (Notification.permission === 'default' && 
                !userDeclined && 
                !userEnabled && 
                box &&
                document.getElementById('splash').style.display === 'none') {
              
              box.style.display = 'block';
              console.log('Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±');
            }
          }, 4000); // Ø§Ù†ØªØ¸Ø§Ø± 4 Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          
          // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯ 8 Ø«ÙˆØ§Ù†ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© âœ…
          setTimeout(() => {
            const manualBtn = document.getElementById('manual-notification-btn');
            const notificationsEnabled = localStorage.getItem('notifications_enabled');
            
            if (manualBtn && notificationsEnabled !== 'true') {
              manualBtn.style.display = 'flex';
            }
          }, 8000);
          
        })
        .catch(error => {
          console.error('Service Worker registration failed:', error);
        });
    }
    
  }, 1000); // ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø©
});
</script>
</body>  
</html>