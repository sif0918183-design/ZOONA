<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>   
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#D32F2F">  
    <meta name="mobile-web-app-capable" content="yes">  
    <meta name="apple-mobile-web-capable" content="yes">  
    <meta name="apple-mobile-app-status-bar-style" content="black-translucent">  
    <meta name="description" content="متجر ZOONA الإلكتروني - التسوق أونلاين في السودان">  
    <meta name="keywords" content="zoona, متجر, تسوق, سوداني, شراء, منتجات, سودان">  
    <meta name="author" content="ZOONA">  
    <title>ZOONA</title>  
    <link rel="manifest" href="manifest.json">  
    <link rel="icon" type="image/png" href="icon/icon-72x72.png">  
    <link rel="apple-touch-icon" href="icon/icon-152x152.png">  
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">  
  
<style>  
    * {  
        margin: 0;  
        padding: 0;  
        box-sizing: border-box;  
        -webkit-tap-highlight-color: transparent;  
    }  
      
    body, html {  
        width: 100%;  
        height: 100%;  
        overflow: hidden;  
        font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, sans-serif;  
        background: #FFFFFF;  
        position: fixed;  
    }  
      
    #splash {  
        position: fixed;  
        top: 0;  
        left: 0;  
        width: 100%;  
        height: 100%;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        display: flex;  
        flex-direction: column;  
        justify-content: center;  
        align-items: center;  
        z-index: 9999;  
        transition: opacity 0.5s;  
    }  
      
    .splash-logo {  
        width: 150px;  
        height: 150px;  
        margin-bottom: 20px;  
        animation: pulse 2s infinite;  
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));  
    }  
      
    .splash-text {  
        color: white;  
        font-size: 20px;  
        font-weight: 700;  
        margin-top: 20px;  
        letter-spacing: 1px;  
        font-family: 'Tajawal', sans-serif;  
    }  
      
    .loader {  
        width: 60px;  
        height: 4px;  
        background: rgba(255,255,255,0.3);  
        margin-top: 30px;  
        border-radius: 2px;  
        overflow: hidden;  
    }  
      
    .loader::after {  
        content: '';  
        display: block;  
        width: 50%;  
        height: 100%;  
        background: white;  
        border-radius: 2px;  
        animation: loading 1.5s infinite ease-in-out;  
    }  
      
    @keyframes pulse {  
        0% { transform: scale(1); }  
        50% { transform: scale(1.05); }  
        100% { transform: scale(1); }  
    }  
      
    @keyframes loading {  
        0% { transform: translateX(-100%); }  
        100% { transform: translateX(200%); }  
    }  
      
    #webview-container {  
        width: 100%;  
        height: 100%;  
        display: none;  
    }  
      
    #webview {  
        width: 100%;  
        height: 100%;  
        border: none;  
        background: #FFFFFF;  
    }  
      
    .status-bar {  
        height: env(safe-area-inset-top, 0px);  
        background: #D32F2F;  
        width: 100%;  
    }  
      
    #back-button {  
        position: fixed;  
        bottom: 25px;  
        left: 25px;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        color: white;  
        width: 56px;  
        height: 56px;  
        border-radius: 28px;  
        display: none;  
        justify-content: center;  
        align-items: center;  
        box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);  
        z-index: 1000;  
        border: none;  
        cursor: pointer;  
        font-size: 22px;  
        font-weight: bold;  
        transition: all 0.3s ease;  
        font-family: 'Tajawal', sans-serif;  
    }  
      
    #back-button:hover {  
        transform: scale(1.1);  
        box-shadow: 0 8px 25px rgba(211, 47, 47, 0.5);  
    }  
      
    #back-button:active {  
        transform: scale(0.95);  
    }  
      
    #toast {  
        position: fixed;  
        bottom: 90px;  
        left: 50%;  
        transform: translateX(-50%);  
        background: #D32F2F;  
        color: white;  
        padding: 16px 32px;  
        border-radius: 28px;  
        display: none;  
        z-index: 1001;  
        box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);  
        font-weight: 600;  
        max-width: 85%;  
        text-align: center;  
        backdrop-filter: blur(10px);  
        border: 1px solid rgba(255,255,255,0.1);  
        font-family: 'Tajawal', sans-serif;  
        font-size: 15px;  
        animation: slideUp 0.3s ease-out;  
    }  
      
    @keyframes slideUp {  
        from {  
            opacity: 0;  
            transform: translateX(-50%) translateY(20px);  
        }  
        to {  
            opacity: 1;  
            transform: translateX(-50%) translateY(0);  
        }  
    }  
      
    .offline-message {  
        position: fixed;  
        top: 0;  
        left: 0;  
        width: 100%;  
        background: #B71C1C;  
        color: white;  
        text-align: center;  
        padding: 16px;  
        display: none;  
        z-index: 1002;  
        font-weight: 600;  
        box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);  
        font-family: 'Tajawal', sans-serif;  
        font-size: 15px;  
    }  
      
    #refresh-button {  
        position: fixed;  
        bottom: 25px;  
        right: 25px;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        color: white;  
        width: 56px;  
        height: 56px;  
        border-radius: 28px;  
        display: none;  
        justify-content: center;  
        align-items: center;  
        box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);  
        z-index: 1000;  
        border: none;  
        cursor: pointer;  
        font-size: 22px;  
        transition: all 0.3s ease;  
        font-family: 'Tajawal', sans-serif;  
    }  
      
    #refresh-button:hover {  
        transform: rotate(30deg);  
    }  
      
    /* تحسين لمؤشر السحب */  
    .pull-indicator {  
        position: fixed;  
        top: -80px;  
        left: 0;  
        width: 100%;  
        height: 80px;  
        background: linear-gradient(to bottom, #D32F2F, #B71C1C);  
        display: flex;  
        justify-content: center;  
        align-items: center;  
        color: white;  
        z-index: 999;  
        transition: top 0.3s ease;  
        font-family: 'Tajawal', sans-serif;  
        font-weight: 600;  
        font-size: 16px;  
        padding-top: env(safe-area-inset-top, 0px);  
    }  
      
    .pull-indicator.show {  
        top: 0;  
    }  
      
    .pull-indicator .icon {  
        margin-left: 10px;  
        font-size: 20px;  
        transition: transform 0.3s;  
    }  
      
    .background-pattern {  
        position: fixed;  
        top: 0;  
        left: 0;  
        width: 100%;  
        height: 100%;  
        background-image:   
            radial-gradient(circle at 25% 25%, rgba(211, 47, 47, 0.03) 0%, transparent 50%),  
            radial-gradient(circle at 75% 75%, rgba(183, 28, 28, 0.03) 0%, transparent 50%);  
        pointer-events: none;  
        z-index: -1;  
    }  
      
    .welcome-message {  
        position: fixed;  
        top: 20px;  
        right: 20px;  
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);  
        color: white;  
        padding: 12px 24px;  
        border-radius: 25px;  
        z-index: 1003;  
        box-shadow: 0 6px 20px rgba(211, 47, 47, 0.3);  
        font-family: 'Tajawal', sans-serif;  
        font-weight: 700;  
        font-size: 15px;  
        display: none;  
        animation: fadeInDown 0.5s ease-out;  
        border: 2px solid rgba(255,255,255,0.2);  
    }  
      
    @keyframes fadeInDown {  
        from {  
            opacity: 0;  
            transform: translateY(-20px);  
        }  
        to {  
            opacity: 1;  
            transform: translateY(0);  
        }  
    }  
</style>

</head>  
<body id="zoona-app" data-app-type="webview" data-store="sudan">  
    <div class="background-pattern"></div>
    <div class="status-bar"></div>
    <div class="welcome-message" id="welcome-message">أهلاً بك في متجر ZOONA السوداني</div>
    <div class="pull-indicator" id="pull-indicator">
        <span>حرر لتحديث الصفحة</span>
        <span class="icon">⟳</span>
    </div>
    <div id="splash">  
        <img src="assets/splash-logo.png" alt="ZOONA Logo" class="splash-logo">  
        <div class="splash-text">ZOONA</div>  
        <div class="loader"></div>  
    </div>
    <div class="offline-message" id="offline-message">⚠️ أنت غير متصل بالإنترنت. جاري استخدام النسخة المخزنة.</div>
    <div id="webview-container">  
        <iframe id="webview"   
                allow="geolocation; camera; microphone; autoplay; clipboard-write; encrypted-media"  
                allowfullscreen  
                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-downloads"  
                referrerpolicy="strict-origin-when-cross-origin"  
                title="متجر ZOONA السوداني"></iframe>  
    </div>
    <button id="back-button" aria-label="رجوع">←</button>  
    <button id="refresh-button" aria-label="تحديث">↻</button>
    <div id="toast"></div>
  
<script>  
    // استخراج الرابط المطلوب من متغير url  
    const params = new URLSearchParams(window.location.search);  
    let siteURL = params.get("url");  

    // اذا لم يوجد رابط → نفتح الصفحة الرئيسية  
    if (!siteURL) {  
        siteURL = "https://www.zoonasd.com/";  
    }  

    // المتغيرات العامة  
    const appName = "ZOONA";  
    const webview = document.getElementById("webview");  
    const splash = document.getElementById("splash");  
    const webviewContainer = document.getElementById('webview-container');  
    const backButton = document.getElementById('back-button');  
    const refreshButton = document.getElementById('refresh-button');  
    const toast = document.getElementById('toast');  
    const offlineMessage = document.getElementById('offline-message');  
    const welcomeMessage = document.getElementById('welcome-message');  
    const pullIndicator = document.getElementById('pull-indicator');  
    const appBaseURL = window.location.origin + window.location.pathname;
      
    // تعيين عنوان التطبيق  
    document.title = appName;  
      
    // متغيرات السحب للتحديث  
    let startY = 0;  
    let currentY = 0;  
    let isPulling = false;  
    let pullStartTime = 0;  
    let isRefreshing = false;
    
    // دالة لتحديث رابط المتصفح
    function updateBrowserURL(currentPageURL) {
        try {
            // إنشاء رابط جديد للصفحة الحالية
            const newURL = `${appBaseURL}?url=${encodeURIComponent(currentPageURL)}`;
            
            // تحديث رابط المتصفح بدون إعادة تحميل الصفحة
            if (window.history && window.history.replaceState) {
                window.history.replaceState(null, '', newURL);
                console.log('تم تحديث الرابط:', newURL);
            }
        } catch (error) {
            console.error('خطأ في تحديث الرابط:', error);
        }
    }
      
    // تهيئة Service Worker  
    if ('serviceWorker' in navigator) {  
        window.addEventListener('load', () => {  
            navigator.serviceWorker.register('service-worker.js')  
                .then(registration => {  
                    console.log('ServiceWorker مسجل بنجاح لتطبيق ZOONA');  
                })  
                .catch(err => {  
                    console.error('فشل تسجيل ServiceWorker:', err);  
                });  
        });  
    }  
      
    // دالة لإظهار الإشعارات  
    function showToast(message, duration = 3000) {  
        toast.textContent = message;  
        toast.style.display = 'block';  
          
        setTimeout(() => {  
            toast.style.display = 'none';  
        }, duration);  
    }  
      
    // دالة لإظهار رسالة الترحيب  
    function showWelcomeMessage() {  
        const today = new Date().toDateString();  
        const lastWelcomeDate = localStorage.getItem('zoona_last_welcome_date');  
          
        if (lastWelcomeDate !== today) {  
            welcomeMessage.style.display = 'block';  
            localStorage.setItem('zoona_last_welcome_date', today);  
              
            setTimeout(() => {  
                welcomeMessage.style.display = 'none';  
            }, 5000);  
              
            showToast('مرحباً بك في أكبر المتاجر السودانية ', 3000);  
        }  
    }  
      
    // دالة لإظهار رسالة عدم الاتصال  
    function showOfflineMessage() {  
        offlineMessage.style.display = 'block';  
        showToast('تم تفعيل وضع العمل دون اتصال', 3000);  
          
        setTimeout(() => {  
            offlineMessage.style.display = 'none';  
        }, 5000);  
    }  
      
    // التحقق من الاتصال بالإنترنت  
    function updateOnlineStatus() {  
        if (navigator.onLine) {  
            offlineMessage.style.display = 'none';  
              
            if (!isPulling) {  
                pullIndicator.classList.remove('show');  
            }  
        } else {  
            showOfflineMessage();  
        }  
    }  
      
    // مستمعات حالة الاتصال  
    window.addEventListener('online', updateOnlineStatus);  
    window.addEventListener('offline', updateOnlineStatus);  
      
    // نظام السحب لأسفل للتحديث المحسن
    let lastScrollTop = 0;
    
    document.addEventListener('touchstart', (e) => {
        // التحقق إذا كنا في أعلى الصفحة
        const webviewScrollTop = webview.contentWindow?.pageYOffset || 0;
        
        if (webviewScrollTop <= 5 && !isPulling && !isRefreshing) {
            startY = e.touches[0].clientY;
            currentY = startY;
            isPulling = true;
            pullStartTime = Date.now();
            
            // إعادة تعيين المؤشر
            pullIndicator.style.top = '-80px';
            pullIndicator.querySelector('.icon').style.transform = 'rotate(0deg)';
        }
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        
        currentY = e.touches[0].clientY;
        const pullDistance = currentY - startY;
        
        if (pullDistance > 0) {
            e.preventDefault();
            
            // حساب المسافة مع حد أقصى
            const maxPull = 150;
            const calculatedTop = Math.min(pullDistance, maxPull) - 80;
            pullIndicator.style.top = calculatedTop + 'px';
            
            // تدوير الأيقونة بناءً على المسافة
            const iconRotation = Math.min((pullDistance / maxPull) * 360, 360);
            pullIndicator.querySelector('.icon').style.transform = `rotate(${iconRotation}deg)`;
            
            // تغيير النص بناءً على المسافة
            if (pullDistance > 100) {
                pullIndicator.querySelector('span:first-child').textContent = 'حرر لتحديث الصفحة';
                pullIndicator.classList.add('show');
            } else {
                pullIndicator.querySelector('span:first-child').textContent = 'اسحب للتحديث';
                pullIndicator.classList.remove('show');
            }
        }
    });
    
    document.addEventListener('touchend', () => {
        if (!isPulling) return;
        
        const pullDistance = currentY - startY;
        const pullDuration = Date.now() - pullStartTime;
        
        isPulling = false;
        
        // إرجاع المؤشر إلى الأعلى بسلاسة
        pullIndicator.style.transition = 'top 0.3s ease';
        pullIndicator.style.top = '-80px';
        
        setTimeout(() => {
            pullIndicator.style.transition = '';
        }, 300);
        
        // إذا تجاوز السحب 100 بكسل وكانت المدة أقل من ثانية
        if (pullDistance > 100 && pullDuration < 1000) {
            isRefreshing = true;
            pullIndicator.classList.remove('show');
            
            showToast('جاري تحديث الصفحة...', 1500);
            
            // تحديث صفحة الويب الحالية
            if (webview.contentWindow) {
                setTimeout(() => {
                    webview.contentWindow.location.reload();
                    isRefreshing = false;
                }, 300);
            }
        } else if (pullDistance > 50) {
            // سحب غير كافي، إرجاع بسلاسة
            pullIndicator.querySelector('.icon').style.transform = 'rotate(0deg)';
        }
    });
      
    // تهيئة التطبيق  
    document.addEventListener('DOMContentLoaded', () => {  
        updateOnlineStatus();  
          
        // محاكاة وقت تحميل الشاشة  
        setTimeout(() => {  
            loadWebview();  
        }, 2000);  
          
        // زر العودة  
        backButton.addEventListener('click', () => {  
            if (webview.contentWindow && webview.contentWindow.history.length > 1) {  
                webview.contentWindow.history.back();  
                showToast('جاري الرجوع للصفحة السابقة', 1500);  
            }  
        });  
          
        // زر التحديث  
        refreshButton.addEventListener('click', () => {  
            if (webview.contentWindow) {  
                showToast('جاري تحديث الصفحة...', 1500);  
                webview.contentWindow.location.reload();  
            }  
        });  
          
        // تحديث ظهور أزرار التحكم  
        setInterval(() => {  
            try {  
                // زر العودة  
                if (webview.contentWindow && webview.contentWindow.history.length > 1) {  
                    backButton.style.display = 'flex';  
                } else {  
                    backButton.style.display = 'none';  
                }  
                  
                // زر التحديث  
                if (webview.contentWindow) {  
                    refreshButton.style.display = 'flex';  
                }  
            } catch (e) {  
                backButton.style.display = 'none';  
                refreshButton.style.display = 'none';  
            }  
        }, 1000);  
    });  
      
    // تحميل الموقع  
    function loadWebview() {  
        webview.src = siteURL;  
          
        webview.onload = () => {  
            // إخفاء شاشة التحميل  
            splash.style.opacity = '0';  
            setTimeout(() => {  
                splash.style.display = 'none';  
                webviewContainer.style.display = 'block';  
            }, 500);  
              
            // تحديث عنوان الصفحة  
            try {  
                const pageTitle = webview.contentWindow.document.title;  
                const currentURL = webview.contentWindow.location.href;
                
                // تحديث رابط المتصفح للصفحة الحالية
                updateBrowserURL(currentURL);
                
                if (pageTitle && pageTitle !== "" && pageTitle !== "ZOONA") {  
                    document.title = `${pageTitle} | ${appName}`;  
                }  
            } catch (e) {  
                console.log('لا يمكن الوصول إلى عنوان الصفحة:', e);  
            }  
              
            // إظهار رسالة الترحيب بعد تأخير بسيط  
            setTimeout(() => {  
                showWelcomeMessage();  
            }, 1000);  
              
            // مراقبة تغييرات الرابط داخل الـ webview
            setupWebviewNavigationTracking();
              
            // إرسال رسالة تفيد بأن التطبيق جاهز  
            try {  
                webview.contentWindow.postMessage({  
                    type: 'app_ready',  
                    app_name: 'ZOONA Store',  
                    country: 'Sudan',  
                    features: {  
                        storage: true,  
                        geolocation: true,  
                        download: true,  
                        version: '1.0.0',  
                        currency: 'SDG'  
                    }  
                }, '*');  
            } catch (e) {  
                console.log('لا يمكن إرسال الرسالة للإطار');  
            }  
        };  
          
        webview.onerror = () => {  
            splash.innerHTML = `  
                <div style="text-align: center; color: white; padding: 20px; font-family: 'Tajawal', sans-serif;">  
                    <h2 style="margin-bottom: 20px; font-weight: 700;">⚠️ حدث خطأ في التحميل</h2>  
                    <p style="margin-bottom: 30px; font-size: 16px;">يرجى التحقق من اتصال الإنترنت</p>  
                    <button onclick="location.reload()" style="  
                        margin-top: 20px;  
                        padding: 12px 40px;  
                        background: white;  
                        color: #D32F2F;  
                        border: none;  
                        border-radius: 25px;  
                        font-size: 16px;  
                        cursor: pointer;  
                        font-weight: bold;  
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);  
                        font-family: 'Tajawal', sans-serif;  
                        transition: all 0.3s;  
                    " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';"  
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">  
                        إعادة المحاولة  
                    </button>  
                </div>  
            `;  
            showToast('فشل تحميل الموقع، يرجى المحاولة مرة أخرى', 4000);  
        };  
    }
    
    // تتبع التنقل داخل الـ webview
    function setupWebviewNavigationTracking() {
        // مراقبة تغييرات الرابط داخل iframe
        let lastURL = webview.src;
        
        setInterval(() => {
            try {
                const currentURL = webview.contentWindow.location.href;
                
                if (currentURL !== lastURL) {
                    lastURL = currentURL;
                    
                    // تحديث رابط المتصفح
                    updateBrowserURL(currentURL);
                    
                    // تحديث عنوان الصفحة
                    const pageTitle = webview.contentWindow.document.title;
                    if (pageTitle && pageTitle !== "" && pageTitle !== "ZOONA") {
                        document.title = `${pageTitle} | ${appName}`;
                    }
                    
                    console.log('تم تغيير الصفحة إلى:', currentURL);
                }
            } catch (e) {
                // صمت على الأخطاء المتعلقة بحق الوصول
            }
        }, 500);
        
        // إضافة مستمع لتغييرات الرابط عبر التاريخ
        try {
            const pushState = webview.contentWindow.history.pushState;
            const replaceState = webview.contentWindow.history.replaceState;
            
            webview.contentWindow.history.pushState = function() {
                pushState.apply(this, arguments);
                setTimeout(() => {
                    updateBrowserURL(webview.contentWindow.location.href);
                }, 100);
            };
            
            webview.contentWindow.history.replaceState = function() {
                replaceState.apply(this, arguments);
                setTimeout(() => {
                    updateBrowserURL(webview.contentWindow.location.href);
                }, 100);
            };
        } catch (e) {
            console.log('لا يمكن تعديل التاريخ:', e);
        }
    }
      
    // ------------ نظام الرسائل بين التطبيق والموقع ------------  
    window.addEventListener("message", function(event) {  
        // طلب الموقع الجغرافي  
        if (event.data === "request_location") {  
            navigator.geolocation.getCurrentPosition(  
                (pos) => {  
                    webview.contentWindow.postMessage({  
                        status: "success",  
                        latitude: pos.coords.latitude,  
                        longitude: pos.coords.longitude,  
                        accuracy: pos.coords.accuracy,  
                        timestamp: pos.timestamp  
                    }, "*");  
                },  
                (err) => {  
                    webview.contentWindow.postMessage({  
                        status: "error",  
                        message: err.message,  
                        code: err.code  
                    }, "*");  
                },  
                {  
                    enableHighAccuracy: true,  
                    timeout: 15000,  
                    maximumAge: 0  
                }  
            );  
        }  
          
        // تنزيل الملفات  
        else if (event.data.type === "download_file") {  
            const { url, filename, type } = event.data;  
            downloadFile(url, filename, type);  
        }  
          
        // حفظ البيانات  
        else if (event.data.type === "save_data") {  
            const { key, value } = event.data;  
            localStorage.setItem(`zoona_${key}`, JSON.stringify(value));  
            webview.contentWindow.postMessage({  
                type: "data_saved",  
                key: key,  
                success: true  
            }, "*");  
            showToast('تم حفظ البيانات بنجاح ✓', 2000);  
        }  
          
        // جلب البيانات  
        else if (event.data.type === "get_data") {  
            const { key } = event.data;  
            const value = localStorage.getItem(`zoona_${key}`);  
            webview.contentWindow.postMessage({  
                type: "data_retrieved",  
                key: key,  
                value: value ? JSON.parse(value) : null,  
                success: true  
            }, "*");  
        }  
          
        // مسح البيانات  
        else if (event.data.type === "clear_data") {  
            const { key } = event.data;  
            if (key === 'all') {  
                localStorage.clear();  
                showToast('تم مسح جميع البيانات', 2000);  
            } else {  
                localStorage.removeItem(`zoona_${key}`);  
                showToast('تم مسح البيانات', 2000);  
            }  
        }
        
        // تحديث الرابط من داخل الموقع
        else if (event.data.type === "update_url") {
            const { url } = event.data;
            if (url) {
                updateBrowserURL(url);
            }
        }  
    });  
      
    // دالة تنزيل الملفات  
    function downloadFile(url, filename, type = 'image') {  
        showToast(`جاري تنزيل ${filename}... ⏳`, 3000);  
          
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');  
        const finalFilename = `${filename.replace(/\.[^/.]+$/, "")}_${timestamp}${filename.match(/\.[^/.]+$/)?.[0] || ''}`;  
          
        fetch(url, {  
            mode: 'cors',  
            credentials: 'include'  
        })  
        .then(response => {  
            if (!response.ok) throw new Error('فشل تحميل الملف');  
            return response.blob();  
        })  
        .then(blob => {  
            const url = window.URL.createObjectURL(blob);  
            const a = document.createElement('a');  
            a.style.display = 'none';  
            a.href = url;  
            a.download = finalFilename;  
            a.setAttribute('download', finalFilename);  
              
            document.body.appendChild(a);  
            a.click();  
            window.URL.revokeObjectURL(url);  
            a.remove();  
              
            showToast(`تم تنزيل ${filename} بنجاح ✅`, 3000);  
              
            webview.contentWindow.postMessage({  
                type: "download_complete",  
                filename: finalFilename,  
                originalName: filename,  
                success: true,  
                timestamp: new Date().toISOString()  
            }, "*");  
              
            const downloads = JSON.parse(localStorage.getItem('zoona_downloads') || '[]');  
            downloads.unshift({  
                filename: finalFilename,  
                originalName: filename,  
                type: type,  
                date: new Date().toISOString(),  
                url: url  
            });  
            localStorage.setItem('zoona_downloads', JSON.stringify(downloads.slice(0, 50)));  
        })  
        .catch(err => {  
            console.error('خطأ في التنزيل:', err);  
            showToast('فشل التنزيل، يرجى المحاولة مرة أخرى', 3000);  
              
            webview.contentWindow.postMessage({  
                type: "download_complete",  
                filename: filename,  
                success: false,  
                error: err.message  
            }, "*");  
        });  
    }  
      
    // منع الإجراءات الافتراضية  
    document.addEventListener('contextmenu', e => {  
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {  
            e.preventDefault();  
        }  
    });  
      
    // دعم التثبيت كـ PWA  
    let deferredPrompt;  
      
    window.addEventListener('beforeinstallprompt', (e) => {  
        e.preventDefault();  
        deferredPrompt = e;  
    });  
      
    // إدارة الذاكرة  
    window.addEventListener('load', () => {  
        const now = new Date().getTime();  
        const cacheData = JSON.parse(localStorage.getItem('zoona_cache_meta') || '{}');  
          
        for (const key in cacheData) {  
            if (now - cacheData[key].timestamp > 7 * 24 * 60 * 60 * 1000) {  
                localStorage.removeItem(key);  
                delete cacheData[key];  
            }  
        }  
          
        localStorage.setItem('zoona_cache_meta', JSON.stringify(cacheData));  
    });  
      
    // تحسين الأداء  
    let isScrolling;  
    window.addEventListener('scroll', () => {  
        window.clearTimeout(isScrolling);  
          
        isScrolling = setTimeout(() => {  
            backButton.style.opacity = '0.7';  
            refreshButton.style.opacity = '0.7';  
              
            setTimeout(() => {  
                backButton.style.opacity = '1';  
                refreshButton.style.opacity = '1';  
            }, 100);  
        }, 66);  
    }, false);  
      
    // تحديث تاريخ أول استخدام  
    if (!localStorage.getItem('zoona_first_use')) {  
        localStorage.setItem('zoona_first_use', new Date().toISOString());  
    }  
</script>

<!-- صندوق تثبيت PWA مُحسّن -->
<div style="  
position: fixed;  
right: 16px;  
left: 16px;  
bottom: 20px;  
max-width: 420px;  
margin: 0 auto;  
border-radius: 20px;  
padding: 24px;  
background: #ffffff;  
color: #333333;  
box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.05);  
display: none;  
z-index: 100000;  
font-family: 'Tajawal', 'Segoe UI', Tahoma, sans-serif;  
direction: rtl;"  
id="pwa-install-box" aria-hidden="true" role="dialog">  
    <div id="pwa-close" title="إغلاق" style="  
        position:absolute;top:12px;left:12px;color:#999;font-size:20px;  
        cursor:pointer;width:32px;height:32px;display:flex;  
        align-items:center;justify-content:center;border-radius:50%;  
        transition: color 0.3s, background-color 0.3s;">  
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>  
    </div>  
    
    <div style="display:flex;gap:16px;align-items:center;">  
        <div style="  
            width: 72px;  
            height: 72px;  
            border-radius: 18px;  
            background: #f7f7f7;  
            display:flex;align-items:center;justify-content:center;  
            flex-shrink:0;box-shadow: 0 4px 12px rgba(0,0,0,0.1);  
            overflow:hidden;">  
            <img src="https://i.ibb.co/pvjQjT2V/icon-512x512.png"   
                 style="width: 52px; height: 52px; border-radius: 10px; object-fit: cover;">  
        </div>  
    
        <div style="flex:1;text-align:right;">  
            <div style="font-weight: 800; font-size: 18px; margin-bottom: 4px; color: #c62828;">  
                تثبيت تطبيق <span style="font-family:'Segoe UI', Tahoma, sans-serif;">ZOONA</span>  
            </div>  
            <div style="font-size: 14px; color: #555555; line-height: 1.5;">  
                ✨ تجربة شراء أسرع — تثبيت مباشر بنقرة واحدة  
            </div>  
        </div>  
    </div>  
    
    <button id="pwa-install-btn" style="  
        width: 100%;  
        margin-top: 20px;   
        background: #c62828;  
        color: #fff;  
        border: none;  
        padding: 14px 20px;  
        border-radius: 14px;  
        font-weight: 700;  
        cursor: pointer;  
        box-shadow: 0 8px 20px rgba(198, 40, 40, 0.3),  
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);  
        text-align: center;  
        font-size: 16px;  
        letter-spacing: 0.5px;  
        transition: background-color 0.3s ease;">  
        تثبيت الآن وتجربة الأداء الفائق  
    </button>  
</div>  

<script>  
document.addEventListener('DOMContentLoaded', function() {  
    let deferredPrompt = null;  
    const box = document.getElementById('pwa-install-box');  
    const btn = document.getElementById('pwa-install-btn');  
    const close = document.getElementById('pwa-close');  
  
    // التحقق من تثبيت PWA بدقة أكبر
    function isPWAInstalled() {
        // الطرق المختلفة للتحقق من التثبيت
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
        const isMinimalUI = window.matchMedia('(display-mode: minimal-ui)').matches;
        
        // للـ iOS
        const isIOSStandalone = ('standalone' in window.navigator) && 
                               (window.navigator.standalone === true);
        
        // للتحقق من تطبيقات pwabuilder.com أو أي PWA آخر
        const hasPWALauncher = document.referrer.includes('android-app://') || 
                              window.location.protocol === 'file:';
        
        // التحقق من وجود service worker نشط
        let hasActiveServiceWorker = false;
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            hasActiveServiceWorker = registrations.length > 0;
        }
        
        return isStandalone || isFullscreen || isMinimalUI || isIOSStandalone || 
               hasPWALauncher || hasActiveServiceWorker;
    }  
  
    function hasShownBefore() {  
        return localStorage.getItem('pwaInstallShown') === 'true';  
    }  
    
    function markAsShown() {  
        localStorage.setItem('pwaInstallShown', 'true');  
    }  
  
    // التحقق من جميع المتصفحات
    function isMobileBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
    }
    
    // التحقق من متصفحات iOS
    function isIOSBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        return /iphone|ipad|ipod/.test(userAgent);
    }
    
    // التحقق من متصفحات Android
    function isAndroidBrowser() {
        const userAgent = navigator.userAgent.toLowerCase();
        return /android/.test(userAgent);
    }
  
    window.addEventListener('beforeinstallprompt', (e) => {  
        e.preventDefault();  
        deferredPrompt = e;  
  
        if (isPWAInstalled()) {
            console.log('PWA مثبت بالفعل');
            return;
        }  
        
        if (hasShownBefore()) {
            console.log('تم عرض الرسالة من قبل');
            return;
        }  
  
        // تأخير العرض بحسب نوع الجهاز
        const delay = isMobileBrowser() ? 3000 : 5000;
        
        setTimeout(() => {  
            box.style.display = 'block';
            console.log('عرض رسالة التثبيت');
        }, delay);  
    });  
  
    // معالجة المتصفحات التي لا تدعم beforeinstallprompt
    if (!('beforeinstallprompt' in window)) {
        setTimeout(() => {
            if (!isPWAInstalled() && !hasShownBefore()) {
                // عرض رسالة بديلة للمتصفحات القديمة
                console.log('المتصفح لا يدعم التثبيت التلقائي');
                
                // يمكنك إضافة زر يدوي للتثبيت
                // أو عرض تعليمات للمستخدم
            }
        }, 5000);
    }
  
    btn.addEventListener('click', async () => {  
        if (!deferredPrompt) {  
            box.style.display = 'none';  
            markAsShown();  
            
            // توجيه المستخدم للتعليمات حسب المتصفح
            if (isIOSBrowser()) {
                alert('لتثبيت التطبيق على iOS:\n1. اضغط على زر المشاركة\n2. اختر "إضافة إلى الشاشة الرئيسية"');
            } else if (isAndroidBrowser()) {
                alert('لتثبيت التطبيق على Android:\n1. اضغط على القائمة (النقاط الثلاث)\n2. اختر "إضافة إلى الشاشة الرئيسية"');
            } else {
                alert('لتثبيت التطبيق:\n1. اضغط على القائمة (النقاط الثلاث)\n2. اختر "تثبيت التطبيق" أو "إضافة إلى الشاشة الرئيسية"');
            }
            
            return;  
        }  
  
        try {
            deferredPrompt.prompt();  
            const choiceResult = await deferredPrompt.userChoice;
            
            if (choiceResult.outcome === 'accepted') {
                console.log('قام المستخدم بتثبيت PWA');
            } else {
                console.log('رفض المستخدم تثبيت PWA');
            }
        } catch (error) {
            console.error('خطأ في تثبيت PWA:', error);
        }
        
        box.style.display = 'none';  
        markAsShown();  
        deferredPrompt = null;  
    });  
  
    close.addEventListener('click', () => {  
        box.style.display = 'none';  
        markAsShown();  
    });  
  
    close.addEventListener('mouseenter', () => {  
        close.style.backgroundColor = '#f0f0f0';  
        close.style.color = '#333';  
    });  
  
    close.addEventListener('mouseleave', () => {  
        close.style.backgroundColor = 'transparent';  
        close.style.color = '#999';  
    });  
  
    // إضافة تأثير hover للزر
    btn.addEventListener('mouseenter', () => {  
        btn.style.backgroundColor = '#b71c1c';  
    });  
    
    btn.addEventListener('mouseleave', () => {  
        btn.style.backgroundColor = '#c62828';  
    });  
  
    // التحقق عند تحميل الصفحة
    if (isPWAInstalled()) {  
        box.style.display = 'none';  
    }  
    
    // إخفاء الصندوق عند النقر خارجيه (اختياري)
    document.addEventListener('click', (e) => {
        if (box.style.display === 'block' && 
            !box.contains(e.target) && 
            e.target !== btn) {
            box.style.display = 'none';
            markAsShown();
        }
    });
});  
</script>

<!-- طلب تفعيل الإشعارات من زونا -->  
<div id="custom-notification-prompt" style="  
    position: fixed;   
    bottom: 20px;   
    left: 50%;   
    transform: translateX(-50%);   
    z-index: 10000;   
    background-color: #fff;   
    border: 2px solid #ff4500;   
    border-radius: 18px;   
    padding: 25px;   
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);   
    max-width: 500px;   
    width: 90%;   
    display: none;   
    text-align: center;   
    font-family: 'Tajawal', sans-serif;  
    animation: promptSlideUp 0.5s ease forwards;">  
    <div style="color: #ff4500; font-weight: 800; margin-bottom: 15px; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; gap: 10px;">  
        <span>هل ترغب في الحصول على هدايا حصرية من زونا؟</span>  
    </div>  
    
    <p style="color: #444; margin-bottom: 25px; font-size: 1.1rem; line-height: 1.6;">  
        فعّل الإشعارات الآن لتصلك عروض خاصة وخصومات مميزة قبل الجميع!  
    </p>  
    
    <div style="background-color: #fff9f7; border-radius: 12px; padding: 15px; margin-bottom: 25px; text-align: right;">  
        <div style="display: flex; align-items: center; justify-content: flex-end; margin-bottom: 10px; color: #555;">  
            <span>خصومات حصرية تصل إلى 50%</span>  
            <span style="color: #ff4500; margin-left: 8px; font-size: 1.2rem;"></span>  
        </div>  
        <div style="display: flex; align-items: center; justify-content: flex-end; margin-bottom: 10px; color: #555;">  
            <span>إشعارات فورية عن العروض الجديدة</span>  
            <span style="color: #ff4500; margin-left: 8px; font-size: 1.2rem;">⚡</span>  
        </div>  
        <div style="display: flex; align-items: center; justify-content: flex-end; color: #555;">  
            <span>هدايا مجانية</span>  
            <span style="color: #ff4500; margin-left: 8px; font-size: 1.2rem;"></span>  
        </div>  
    </div>  
    
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 15px;">  
        <button id="activate-notifications" style="  
            background-color: #ff4500;   
            color: white;   
            border: none;   
            padding: 14px 28px;   
            border-radius: 12px;   
            font-weight: 700;   
            cursor: pointer;   
            transition: all 0.3s ease;   
            font-size: 1.05rem;   
            flex: 1;   
            min-width: 160px;   
            box-shadow: 0 4px 12px rgba(255, 69, 0, 0.25);">  
            تفعيل الآن ❤️‍  
        </button>  
        <button id="decline-notifications" style="  
            background-color: #f0f2f5;   
            color: #666;   
            border: 1px solid #ddd;   
            padding: 14px 28px;   
            border-radius: 12px;   
            font-weight: 700;   
            cursor: pointer;   
            transition: all 0.3s ease;   
            font-size: 1.05rem;   
            flex: 1;   
            min-width: 160px;">  
            عدم التفعيل  
        </button>  
    </div>  
    
    <p style="margin-top: 20px; color: #888; font-size: 0.9rem;">  
        يمكنك تغيير هذا الإعداد لاحقاً من إعدادات المتصفح  
    </p>  
</div>  

<style>  
    @keyframes promptSlideUp {  
        from {  
            opacity: 0;  
            transform: translateX(-50%) translateY(30px);  
        }  
        to {  
            opacity: 1;  
            transform: translateX(-50%) translateY(0);  
        }  
    }  
      
    @media (max-width: 768px) {  
        #custom-notification-prompt {  
            padding: 20px;  
            width: 95%;  
            border-radius: 16px;  
        }  
          
        #custom-notification-prompt > div:first-child {  
            font-size: 1.3rem;  
        }  
          
        #custom-notification-prompt p {  
            font-size: 1rem;  
        }  
          
        #activate-notifications, #decline-notifications {  
            padding: 12px 20px;  
            font-size: 1rem;  
            min-width: 140px;  
        }  
    }  
      
    @media (max-width: 480px) {  
        #custom-notification-prompt {  
            padding: 18px;  
            border-radius: 14px;  
        }  
          
        #custom-notification-prompt > div:first-child {  
            font-size: 1.2rem;  
            flex-direction: column;  
            gap: 5px;  
        }  
          
        #activate-notifications, #decline-notifications {  
            width: 100%;  
            min-width: unset;  
        }  
    } 
/* تصغير نافذة الإشعارات على الشاشات الصغيرة جدًا */
@media (max-width: 420px) {
    #custom-notification-prompt {
        max-width: 92%;
        padding: 14px;
        border-radius: 14px;
        bottom: 12px;
    }

    #custom-notification-prompt > div:first-child {
        font-size: 1.05rem;
        gap: 6px;
    }

    #custom-notification-prompt p {
        font-size: 0.95rem;
        margin-bottom: 18px;
        line-height: 1.4;
    }

    #custom-notification-prompt div[style*="background-color"] {
        padding: 10px;
        margin-bottom: 18px;
    }

    #activate-notifications,
    #decline-notifications {
        padding: 10px 14px;
        font-size: 0.95rem;
        border-radius: 10px;
    }
}
</style>  

<script type='module'>  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";  
  import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-messaging.js";  
  
  const firebaseConfig = {  
    apiKey: "AIzaSyBxQLDLqr4W3lApfYLPjSV5It7925a9Rr0",  
    authDomain: "double-carport-476915-j7.firebaseapp.com",  
    projectId: "double-carport-476915-j7",  
    storageBucket: "double-carport-476915-j7.firebasestorage.app",  
    messagingSenderId: "122641462099",  
    appId: "1:122641462099:web:345b777a88757d3ef7e7a6"  
  };  
    
  const VAPID_KEY = "BE2_9m83w2cu_fxhqV4eUowZQT7E8nm-FZZMWqN5DByd-Naykp52nWwA9uuW_L9x_3rPPsMNZzctsZD8j5YyaZw";  
  
  const app = initializeApp(firebaseConfig);  
  const messaging = getMessaging(app);  
  
  function requestAndSaveToken(registration) {  
      Notification.requestPermission().then(permission => {  
          if (permission === "granted") {  
              getToken(messaging, {   
                  vapidKey: VAPID_KEY,  
                  serviceWorkerRegistration: registration   
              })  
              .then(token => {  
                  if (token) {  
                      console.log("FCM Token:", token);  
                      fetch('/api/saveToken', {  
                          method: 'POST',  
                          headers: { 'Content-Type': 'application/json' },  
                          body: JSON.stringify({ token })  
                      })  
                      .then(response => {  
                          if (response.ok) {  
                              console.log('Token saved successfully');  
                              alert('✅ شكراً لتسجيلك! ستتلقى إشعاراتنا الحصرية قريباً.');  
                          } else {  
                              console.error('Failed to save token');  
                          }  
                      })  
                      .catch(error => console.error('Error saving token:', error));  
                  } else {  
                      console.log('No registration token available.');  
                  }  
              })  
              .catch(err => console.error('Error retrieving token: ', err));  
          } else {  
              console.log('Notification permission not granted');  
              alert('❌ لم يتم منح الإذن. لن تصلك إشعاراتنا.');  
          }  
      });  
  }  
  
  if ('serviceWorker' in navigator) {  
    navigator.serviceWorker.register('/service-worker.js', { scope: '/' })  
      .then(registration => {  
        console.log('Service Worker registered:', registration);  
          
        const promptContainer = document.getElementById('custom-notification-prompt');  
        const userDeclined = localStorage.getItem('zona_notifications_declined');  
  
        if (Notification.permission === 'default' && !userDeclined) {  
            setTimeout(() => {  
                if (promptContainer) {  
                    promptContainer.style.display = 'block';  
                }  
            }, 3000);  
  
            const activateBtn = document.getElementById('activate-notifications');  
            const declineBtn = document.getElementById('decline-notifications');  
  
            if (activateBtn) {  
                activateBtn.addEventListener('click', () => {  
                    if (promptContainer) promptContainer.style.display = 'none';  
                    requestAndSaveToken(registration);  
                });  
            }  
              
            if (declineBtn) {  
                declineBtn.addEventListener('click', () => {  
                    if (promptContainer) promptContainer.style.display = 'none';  
                    localStorage.setItem('zona_notifications_declined', 'true');  
                    alert(' لن تصلك إشعاراتنا الحصرية. يمكنك تغيير هذا القرار لاحقاً من إعدادات المتصفح.');  
                    console.log('User declined custom prompt for now.');  
                });  
            }  
  
        } else if (Notification.permission === 'granted') {  
            console.log('الإذن ممنوح بالفعل، جاري تحديث الـ Token...');  
            getToken(messaging, {   
                vapidKey: VAPID_KEY,  
                serviceWorkerRegistration: registration   
            })  
            .then(token => {  
                if (token) {  
                    console.log("FCM Token updated:", token);  
                }  
            })  
            .catch(err => console.error('Error updating token: ', err));  
        } else if (Notification.permission === 'denied') {  
            console.log('المستخدم رفض الإذن مسبقاً');  
        }  
  
      })  
      .catch(err => console.error('Service Worker registration failed:', err));  
  } else {  
    console.warn('Service Worker not supported in this browser');  
  }  
    
  document.addEventListener('DOMContentLoaded', function() {  
      const activateBtn = document.getElementById('activate-notifications');  
      const declineBtn = document.getElementById('decline-notifications');  
        
      if (activateBtn) {  
          activateBtn.addEventListener('mouseenter', function() {  
              this.style.backgroundColor = '#e03e00';  
              this.style.transform = 'translateY(-2px)';  
              this.style.boxShadow = '0 6px 16px rgba(255, 69, 0, 0.3)';  
          });  
            
          activateBtn.addEventListener('mouseleave', function() {  
              this.style.backgroundColor = '#ff4500';  
              this.style.transform = 'translateY(0)';  
              this.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.25)';  
          });  
      }  
        
      if (declineBtn) {  
          declineBtn.addEventListener('mouseenter', function() {  
              this.style.backgroundColor = '#e4e6e9';  
              this.style.transform = 'translateY(-2px)';  
          });  
            
          declineBtn.addEventListener('mouseleave', function() {  
              this.style.backgroundColor = '#f0f2f5';  
              this.style.transform = 'translateY(0)';  
          });  
      }  
  });  
</script> 
</body>  
</html>